{% extends 'base.html' %}
{% load static %}

{% block title %}Visualizer - C-It{% endblock %}

{% block extra_css %}
<style>
    .code-editor {
        font-family: 'Fira Code', 'Monaco', 'Consolas', monospace;
        font-size: 14px;
        line-height: 1.6;
    }
    
    .visualization-container {
        min-height: 500px;
        background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
    }
    
    .array-element {
        transition: all 0.3s ease;
    }
    
    .array-element.highlighted {
        transform: scale(1.1);
        box-shadow: 0 0 20px rgba(59, 130, 246, 0.5);
    }
    
    .array-element.comparing {
        background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
        color: white;
    }
    
    .array-element.swapping {
        background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        color: white;
    }
    
    .array-element.sorted {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        color: white;
    }
    
    .control-panel {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
    }
    
    .step-indicator {
        transition: all 0.3s ease;
    }
    
    .step-indicator.active {
        background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
        color: white;
    }
</style>
{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50">
    <!-- Header -->
    <div class="bg-white shadow-sm border-b">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-3xl font-bold text-gray-900">Algorithm Visualizer</h1>
                    <p class="text-gray-600 mt-1">Input your C code and watch it come to life</p>
                </div>
                <div class="flex space-x-4">
                    <button id="loadExampleBtn" class="btn-secondary text-white px-4 py-2 rounded-lg text-sm font-medium">
                        <i class="fas fa-download mr-2"></i>Load Example
                    </button>
                    <button id="clearBtn" class="bg-gray-500 text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-gray-600 transition-colors">
                        <i class="fas fa-trash mr-2"></i>Clear
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- Code Editor Panel -->
            <div class="space-y-6">
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-xl font-bold text-gray-900">
                            <i class="fas fa-code mr-2 text-blue-500"></i>
                            Code Editor
                        </h2>
                        <div class="flex space-x-2">
                            <button id="formatBtn" class="text-gray-500 hover:text-blue-600 transition-colors">
                                <i class="fas fa-magic"></i>
                            </button>
                            <button id="fullscreenBtn" class="text-gray-500 hover:text-blue-600 transition-colors">
                                <i class="fas fa-expand"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div class="code-editor bg-gray-900 rounded-lg p-4 h-96 overflow-auto">
                        <textarea id="codeEditor" class="w-full h-full bg-transparent text-gray-100 resize-none outline-none" placeholder="// Enter your C code here...
#include <stdio.h>

void bubbleSort(int arr[], int n) {
    int i, j, temp;
    for (i = 0; i < n-1; i++) {
        for (j = 0; j < n-i-1; j++) {
            if (arr[j] > arr[j+1]) {
                temp = arr[j];
                arr[j] = arr[j+1];
                arr[j+1] = temp;
            }
        }
    }
}

int main() {
    int arr[] = {64, 34, 25, 12, 22, 11, 90};
    int n = sizeof(arr)/sizeof(arr[0]);
    bubbleSort(arr, n);
    return 0;
}"></textarea>
                    </div>
                    
                    <div class="mt-4 flex space-x-4">
                        <button id="visualizeBtn" class="btn-primary text-white px-6 py-3 rounded-lg font-medium flex items-center">
                            <i class="fas fa-play mr-2"></i>
                            Visualize Algorithm
                        </button>
                        <button id="stepBtn" class="bg-green-500 text-white px-6 py-3 rounded-lg font-medium hover:bg-green-600 transition-colors flex items-center">
                            <i class="fas fa-step-forward mr-2"></i>
                            Step Through
                        </button>
                    </div>
                </div>
                
                <!-- Algorithm Information -->
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <h3 class="text-lg font-bold text-gray-900 mb-4">
                        <i class="fas fa-info-circle mr-2 text-blue-500"></i>
                        Algorithm Information
                    </h3>
                    <div id="algorithmInfo" class="space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div class="bg-blue-50 p-4 rounded-lg">
                                <h4 class="font-semibold text-blue-900">Algorithm Type</h4>
                                <p id="algorithmType" class="text-blue-700">-</p>
                            </div>
                            <div class="bg-green-50 p-4 rounded-lg">
                                <h4 class="font-semibold text-green-900">Time Complexity</h4>
                                <p id="timeComplexity" class="text-green-700">-</p>
                            </div>
                            <div class="bg-purple-50 p-4 rounded-lg">
                                <h4 class="font-semibold text-purple-900">Space Complexity</h4>
                                <p id="spaceComplexity" class="text-purple-700">-</p>
                            </div>
                            <div class="bg-orange-50 p-4 rounded-lg">
                                <h4 class="font-semibold text-orange-900">Functions Found</h4>
                                <p id="functionsFound" class="text-orange-700">-</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Visualization Panel -->
            <div class="space-y-6">
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-xl font-bold text-gray-900">
                            <i class="fas fa-chart-bar mr-2 text-green-500"></i>
                            Visualization
                        </h2>
                        <div class="flex items-center space-x-4">
                            <div class="flex items-center space-x-2">
                                <span class="text-sm text-gray-600">Speed:</span>
                                <input type="range" id="speedSlider" min="0.5" max="3" step="0.1" value="1" class="w-20">
                                <span id="speedValue" class="text-sm text-gray-600">1x</span>
                            </div>
                            <button id="pauseBtn" class="text-gray-500 hover:text-blue-600 transition-colors">
                                <i class="fas fa-pause"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div id="visualizationCanvas" class="visualization-container rounded-lg border-2 border-dashed border-gray-300 flex items-center justify-center">
                        <div class="text-center text-gray-500">
                            <i class="fas fa-play-circle text-4xl mb-4"></i>
                            <p class="text-lg font-medium">Click "Visualize Algorithm" to start</p>
                            <p class="text-sm">Your algorithm animation will appear here</p>
                        </div>
                    </div>
                    
                    <!-- Control Panel -->
                    <div id="controlPanel" class="control-panel mt-4 p-4 rounded-lg border hidden">
                        <div class="flex items-center justify-between mb-4">
                            <h4 class="font-semibold text-gray-900">Animation Controls</h4>
                            <div class="flex space-x-2">
                                <button id="prevStepBtn" class="bg-gray-500 text-white px-3 py-1 rounded text-sm hover:bg-gray-600 transition-colors">
                                    <i class="fas fa-step-backward mr-1"></i>Prev
                                </button>
                                <button id="nextStepBtn" class="bg-blue-500 text-white px-3 py-1 rounded text-sm hover:bg-blue-600 transition-colors">
                                    <i class="fas fa-step-forward mr-1"></i>Next
                                </button>
                            </div>
                        </div>
                        
                        <div class="flex items-center space-x-4">
                            <div class="flex-1">
                                <div class="flex items-center space-x-2">
                                    <span class="text-sm text-gray-600">Step:</span>
                                    <span id="currentStep" class="font-semibold">0</span>
                                    <span class="text-sm text-gray-600">/</span>
                                    <span id="totalSteps" class="font-semibold">0</span>
                                </div>
                                <div class="w-full bg-gray-200 rounded-full h-2 mt-2">
                                    <div id="progressBar" class="bg-blue-500 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                                </div>
                            </div>
                        </div>
                        
                        <div id="stepDescription" class="mt-4 p-3 bg-blue-50 rounded-lg">
                            <p class="text-sm text-blue-800">Ready to start visualization...</p>
                        </div>
                    </div>
                </div>
                
                <!-- Step Indicators -->
                <div id="stepIndicators" class="bg-white rounded-xl shadow-lg p-6 hidden">
                    <h3 class="text-lg font-bold text-gray-900 mb-4">
                        <i class="fas fa-list-ol mr-2 text-purple-500"></i>
                        Animation Steps
                    </h3>
                    <div id="stepList" class="grid grid-cols-5 gap-2">
                        <!-- Step indicators will be generated here -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Example Modal -->
<div id="exampleModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white rounded-xl shadow-2xl max-w-4xl w-full max-h-screen overflow-y-auto">
            <div class="p-6 border-b">
                <div class="flex items-center justify-between">
                    <h3 class="text-2xl font-bold text-gray-900">Choose an Example</h3>
                    <button id="closeModalBtn" class="text-gray-500 hover:text-gray-700">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
            </div>
            
            <div class="p-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Sorting Examples -->
                    <div>
                        <h4 class="text-lg font-semibold text-gray-900 mb-4">
                            <i class="fas fa-sort mr-2 text-blue-500"></i>
                            Sorting Algorithms
                        </h4>
                        <div class="space-y-3">
                            <button class="example-btn w-full text-left p-3 rounded-lg border hover:bg-blue-50 transition-colors" data-type="bubble_sort">
                                <div class="font-medium text-gray-900">Bubble Sort</div>
                                <div class="text-sm text-gray-600">Simple sorting with O(n²) complexity</div>
                            </button>
                            <button class="example-btn w-full text-left p-3 rounded-lg border hover:bg-blue-50 transition-colors" data-type="quick_sort">
                                <div class="font-medium text-gray-900">Quick Sort</div>
                                <div class="text-sm text-gray-600">Efficient divide-and-conquer sorting</div>
                            </button>
                            <button class="example-btn w-full text-left p-3 rounded-lg border hover:bg-blue-50 transition-colors" data-type="merge_sort">
                                <div class="font-medium text-gray-900">Merge Sort</div>
                                <div class="text-sm text-gray-600">Stable sorting with O(n log n) complexity</div>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Searching Examples -->
                    <div>
                        <h4 class="text-lg font-semibold text-gray-900 mb-4">
                            <i class="fas fa-search mr-2 text-green-500"></i>
                            Searching Algorithms
                        </h4>
                        <div class="space-y-3">
                            <button class="example-btn w-full text-left p-3 rounded-lg border hover:bg-green-50 transition-colors" data-type="binary_search">
                                <div class="font-medium text-gray-900">Binary Search</div>
                                <div class="text-sm text-gray-600">Fast search in sorted arrays</div>
                            </button>
                            <button class="example-btn w-full text-left p-3 rounded-lg border hover:bg-green-50 transition-colors" data-type="linear_search">
                                <div class="font-medium text-gray-900">Linear Search</div>
                                <div class="text-sm text-gray-600">Simple sequential search</div>
                            </button>
                        </div>
                        
                        <h4 class="text-lg font-semibold text-gray-900 mb-4 mt-6">
                            <i class="fas fa-project-diagram mr-2 text-purple-500"></i>
                            Data Structures
                        </h4>
                        <div class="space-y-3">
                            <button class="example-btn w-full text-left p-3 rounded-lg border hover:bg-purple-50 transition-colors" data-type="linked_list">
                                <div class="font-medium text-gray-900">Linked List</div>
                                <div class="text-sm text-gray-600">Dynamic data structure</div>
                            </button>
                            <button class="example-btn w-full text-left p-3 rounded-lg border hover:bg-purple-50 transition-colors" data-type="stack">
                                <div class="font-medium text-gray-900">Stack</div>
                                <div class="text-sm text-gray-600">LIFO data structure</div>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Global variables
let currentVisualization = null;
let currentStep = 0;
let totalSteps = 0;
let isPlaying = false;
let animationSpeed = 1;
let animationInterval = null;

// DOM elements
const codeEditor = document.getElementById('codeEditor');
const visualizeBtn = document.getElementById('visualizeBtn');
const stepBtn = document.getElementById('stepBtn');
const loadExampleBtn = document.getElementById('loadExampleBtn');
const clearBtn = document.getElementById('clearBtn');
const visualizationCanvas = document.getElementById('visualizationCanvas');
const controlPanel = document.getElementById('controlPanel');
const stepIndicators = document.getElementById('stepIndicators');
const stepList = document.getElementById('stepList');
const currentStepSpan = document.getElementById('currentStep');
const totalStepsSpan = document.getElementById('totalSteps');
const progressBar = document.getElementById('progressBar');
const stepDescription = document.getElementById('stepDescription');
const speedSlider = document.getElementById('speedSlider');
const speedValue = document.getElementById('speedValue');
const pauseBtn = document.getElementById('pauseBtn');
const prevStepBtn = document.getElementById('prevStepBtn');
const nextStepBtn = document.getElementById('nextStepBtn');
const exampleModal = document.getElementById('exampleModal');
const closeModalBtn = document.getElementById('closeModalBtn');

// Event listeners
visualizeBtn.addEventListener('click', startVisualization);
stepBtn.addEventListener('click', stepThroughVisualization);
loadExampleBtn.addEventListener('click', showExampleModal);
clearBtn.addEventListener('click', clearCode);
closeModalBtn.addEventListener('click', hideExampleModal);
speedSlider.addEventListener('input', updateSpeed);
pauseBtn.addEventListener('click', togglePause);
prevStepBtn.addEventListener('click', previousStep);
nextStepBtn.addEventListener('click', nextStep);

// Example buttons
document.addEventListener('click', function(e) {
    if (e.target.classList.contains('example-btn')) {
        loadExample(e.target.dataset.type);
    }
});

// Functions
function startVisualization() {
    const code = codeEditor.value.trim();
    if (!code) {
        showNotification('Please enter some C code to visualize', 'error');
        return;
    }
    
    visualizeBtn.disabled = true;
    visualizeBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Processing...';
    
    // Send code to backend
    fetch('/visualize/parse_and_visualize/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({ code: code })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            currentVisualization = data.visualization;
            displayVisualization(data.visualization);
            updateAlgorithmInfo(data.parsed_data);
            showNotification('Visualization generated successfully!', 'success');
        } else {
            showNotification(data.error || 'Failed to generate visualization', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('An error occurred while processing your code', 'error');
    })
    .finally(() => {
        visualizeBtn.disabled = false;
        visualizeBtn.innerHTML = '<i class="fas fa-play mr-2"></i>Visualize Algorithm';
    });
}

function displayVisualization(visualization) {
    currentStep = 0;
    totalSteps = visualization.steps.length;
    isPlaying = false;
    
    // Update UI
    currentStepSpan.textContent = currentStep;
    totalStepsSpan.textContent = totalSteps;
    progressBar.style.width = '0%';
    
    // Show control panel
    controlPanel.classList.remove('hidden');
    stepIndicators.classList.remove('hidden');
    
    // Generate step indicators
    generateStepIndicators();
    
    // Display first step
    displayStep(visualization.steps[0]);
    
    // Start animation
    startAnimation();
}

function displayStep(step) {
    if (!step) return;
    
    // Update step description
    stepDescription.innerHTML = `
        <div class="font-semibold text-blue-900">${step.title}</div>
        <div class="text-sm text-blue-700 mt-1">${step.description}</div>
    `;
    
    // Clear canvas
    visualizationCanvas.innerHTML = '';
    
    // Create visualization based on step type
    if (step.array) {
        createArrayVisualization(step);
    } else if (step.nodes) {
        createLinkedListVisualization(step);
    } else if (step.stack) {
        createStackVisualization(step);
    } else if (step.queue) {
        createQueueVisualization(step);
    } else if (step.hash_map) {
        createHashMapVisualization(step);
    } else {
        createGeneralVisualization(step);
    }
}

function createArrayVisualization(step) {
    const container = document.createElement('div');
    container.className = 'flex flex-wrap justify-center items-center gap-4 p-8';
    
    step.array.forEach((value, index) => {
        const element = document.createElement('div');
        element.className = 'array-element bg-white border-2 border-gray-300 rounded-lg px-4 py-3 text-center min-w-[60px] font-bold text-lg';
        element.textContent = value;
        
        // Add highlighting based on step
        if (step.highlighted && step.highlighted.includes(index)) {
            element.classList.add('highlighted');
        }
        
        if (step.elements && step.elements[0]) {
            const elementData = step.elements[0];
            if (elementData.type === 'comparison' && elementData.indices.includes(index)) {
                element.classList.add('comparing');
            } else if (elementData.type === 'swap' && elementData.indices.includes(index)) {
                element.classList.add('swapping');
            }
        }
        
        container.appendChild(element);
    });
    
    visualizationCanvas.appendChild(container);
}

function createLinkedListVisualization(step) {
    const container = document.createElement('div');
    container.className = 'flex flex-wrap justify-center items-center gap-2 p-8';
    
    step.nodes.forEach((node, index) => {
        const nodeElement = document.createElement('div');
        nodeElement.className = 'bg-white border-2 border-gray-300 rounded-lg px-4 py-3 text-center min-w-[80px] font-bold text-lg';
        nodeElement.textContent = node.value;
        
        if (index === step.highlighted) {
            nodeElement.classList.add('highlighted');
        }
        
        container.appendChild(nodeElement);
        
        // Add arrow if not last node
        if (index < step.nodes.length - 1) {
            const arrow = document.createElement('div');
            arrow.className = 'text-gray-400 text-2xl';
            arrow.innerHTML = '→';
            container.appendChild(arrow);
        }
    });
    
    visualizationCanvas.appendChild(container);
}

function createStackVisualization(step) {
    const container = document.createElement('div');
    container.className = 'flex flex-col items-center p-8';
    
    const stackContainer = document.createElement('div');
    stackContainer.className = 'border-2 border-gray-300 rounded-lg p-4 min-h-[200px] flex flex-col-reverse justify-end';
    
    step.stack.forEach((value, index) => {
        const element = document.createElement('div');
        element.className = 'bg-white border border-gray-300 rounded px-3 py-2 text-center mb-1 font-medium';
        element.textContent = value;
        
        if (index === step.highlighted) {
            element.classList.add('highlighted');
        }
        
        stackContainer.appendChild(element);
    });
    
    container.appendChild(stackContainer);
    
    const label = document.createElement('div');
    label.className = 'text-gray-600 font-medium mt-2';
    label.textContent = 'Stack (LIFO)';
    container.appendChild(label);
    
    visualizationCanvas.appendChild(container);
}

function createQueueVisualization(step) {
    const container = document.createElement('div');
    container.className = 'flex flex-col items-center p-8';
    
    const queueContainer = document.createElement('div');
    queueContainer.className = 'border-2 border-gray-300 rounded-lg p-4 min-h-[200px] flex flex-col justify-end';
    
    step.queue.forEach((value, index) => {
        const element = document.createElement('div');
        element.className = 'bg-white border border-gray-300 rounded px-3 py-2 text-center mb-1 font-medium';
        element.textContent = value;
        
        if (index === step.highlighted) {
            element.classList.add('highlighted');
        }
        
        queueContainer.appendChild(element);
    });
    
    container.appendChild(queueContainer);
    
    const label = document.createElement('div');
    label.className = 'text-gray-600 font-medium mt-2';
    label.textContent = 'Queue (FIFO)';
    container.appendChild(label);
    
    visualizationCanvas.appendChild(container);
}

function createHashMapVisualization(step) {
    const container = document.createElement('div');
    container.className = 'grid grid-cols-2 gap-4 p-8';
    
    Object.entries(step.hash_map).forEach(([key, value]) => {
        const entry = document.createElement('div');
        entry.className = 'bg-white border border-gray-300 rounded-lg p-3 text-center';
        
        const keyElement = document.createElement('div');
        keyElement.className = 'font-bold text-blue-600';
        keyElement.textContent = key;
        
        const valueElement = document.createElement('div');
        valueElement.className = 'text-gray-700';
        valueElement.textContent = value;
        
        entry.appendChild(keyElement);
        entry.appendChild(valueElement);
        container.appendChild(entry);
    });
    
    visualizationCanvas.appendChild(container);
}

function createGeneralVisualization(step) {
    const container = document.createElement('div');
    container.className = 'flex flex-col items-center justify-center p-8 text-center';
    
    step.elements.forEach(element => {
        const elementDiv = document.createElement('div');
        elementDiv.className = 'bg-white border border-gray-300 rounded-lg p-4 mb-4 max-w-md';
        
        if (element.type === 'text') {
            elementDiv.innerHTML = `<div class="font-medium" style="color: ${element.color}">${element.content}</div>`;
        } else if (element.type === 'complexity') {
            elementDiv.innerHTML = `
                <div class="font-bold text-lg mb-2">Complexity Analysis</div>
                <div class="grid grid-cols-2 gap-4">
                    <div class="text-center">
                        <div class="text-sm text-gray-600">Time Complexity</div>
                        <div class="font-bold text-blue-600">${element.time}</div>
                    </div>
                    <div class="text-center">
                        <div class="text-sm text-gray-600">Space Complexity</div>
                        <div class="font-bold text-green-600">${element.space}</div>
                    </div>
                </div>
            `;
        }
        
        container.appendChild(elementDiv);
    });
    
    visualizationCanvas.appendChild(container);
}

function generateStepIndicators() {
    stepList.innerHTML = '';
    
    for (let i = 0; i < totalSteps; i++) {
        const stepIndicator = document.createElement('button');
        stepIndicator.className = 'step-indicator bg-gray-200 text-gray-700 px-3 py-2 rounded text-sm font-medium hover:bg-gray-300 transition-colors';
        stepIndicator.textContent = i + 1;
        stepIndicator.addEventListener('click', () => goToStep(i));
        stepList.appendChild(stepIndicator);
    }
}

function startAnimation() {
    if (animationInterval) {
        clearInterval(animationInterval);
    }
    
    isPlaying = true;
    pauseBtn.innerHTML = '<i class="fas fa-pause"></i>';
    
    animationInterval = setInterval(() => {
        if (currentStep < totalSteps - 1) {
            nextStep();
        } else {
            stopAnimation();
        }
    }, 1000 / animationSpeed);
}

function stopAnimation() {
    isPlaying = false;
    pauseBtn.innerHTML = '<i class="fas fa-play"></i>';
    if (animationInterval) {
        clearInterval(animationInterval);
        animationInterval = null;
    }
}

function togglePause() {
    if (isPlaying) {
        stopAnimation();
    } else {
        startAnimation();
    }
}

function nextStep() {
    if (currentStep < totalSteps - 1) {
        currentStep++;
        updateStepDisplay();
        displayStep(currentVisualization.steps[currentStep]);
    }
}

function previousStep() {
    if (currentStep > 0) {
        currentStep--;
        updateStepDisplay();
        displayStep(currentVisualization.steps[currentStep]);
    }
}

function goToStep(stepIndex) {
    if (stepIndex >= 0 && stepIndex < totalSteps) {
        currentStep = stepIndex;
        updateStepDisplay();
        displayStep(currentVisualization.steps[currentStep]);
    }
}

function updateStepDisplay() {
    currentStepSpan.textContent = currentStep + 1;
    progressBar.style.width = `${((currentStep + 1) / totalSteps) * 100}%`;
    
    // Update step indicators
    const indicators = stepList.querySelectorAll('.step-indicator');
    indicators.forEach((indicator, index) => {
        indicator.classList.remove('active');
        if (index === currentStep) {
            indicator.classList.add('active');
        }
    });
}

function updateSpeed() {
    animationSpeed = parseFloat(speedSlider.value);
    speedValue.textContent = animationSpeed + 'x';
    
    if (isPlaying) {
        stopAnimation();
        startAnimation();
    }
}

function stepThroughVisualization() {
    if (!currentVisualization) {
        showNotification('Please generate a visualization first', 'error');
        return;
    }
    
    if (currentStep < totalSteps - 1) {
        nextStep();
    } else {
        currentStep = 0;
        updateStepDisplay();
        displayStep(currentVisualization.steps[currentStep]);
    }
}

function showExampleModal() {
    exampleModal.classList.remove('hidden');
}

function hideExampleModal() {
    exampleModal.classList.add('hidden');
}

function loadExample(type) {
    // Load example code based on type
    const examples = {
        'bubble_sort': `#include <stdio.h>

void bubbleSort(int arr[], int n) {
    int i, j, temp;
    for (i = 0; i < n-1; i++) {
        for (j = 0; j < n-i-1; j++) {
            if (arr[j] > arr[j+1]) {
                temp = arr[j];
                arr[j] = arr[j+1];
                arr[j+1] = temp;
            }
        }
    }
}

int main() {
    int arr[] = {64, 34, 25, 12, 22, 11, 90};
    int n = sizeof(arr)/sizeof(arr[0]);
    bubbleSort(arr, n);
    return 0;
}`,
        'quick_sort': `#include <stdio.h>

void swap(int* a, int* b) {
    int t = *a;
    *a = *b;
    *b = t;
}

int partition(int arr[], int low, int high) {
    int pivot = arr[high];
    int i = (low - 1);
    
    for (int j = low; j <= high - 1; j++) {
        if (arr[j] < pivot) {
            i++;
            swap(&arr[i], &arr[j]);
        }
    }
    swap(&arr[i + 1], &arr[high]);
    return (i + 1);
}

void quickSort(int arr[], int low, int high) {
    if (low < high) {
        int pi = partition(arr, low, high);
        quickSort(arr, low, pi - 1);
        quickSort(arr, pi + 1, high);
    }
}

int main() {
    int arr[] = {10, 7, 8, 9, 1, 5};
    int n = sizeof(arr)/sizeof(arr[0]);
    quickSort(arr, 0, n-1);
    return 0;
}`,
        'binary_search': `#include <stdio.h>

int binarySearch(int arr[], int l, int r, int x) {
    while (l <= r) {
        int m = l + (r - l) / 2;
        
        if (arr[m] == x)
            return m;
        
        if (arr[m] < x)
            l = m + 1;
        else
            r = m - 1;
    }
    return -1;
}

int main() {
    int arr[] = {2, 3, 4, 10, 40};
    int n = sizeof(arr) / sizeof(arr[0]);
    int x = 10;
    int result = binarySearch(arr, 0, n-1, x);
    return 0;
}`,
        'linked_list': `#include <stdio.h>
#include <stdlib.h>

struct Node {
    int data;
    struct Node* next;
};

struct Node* newNode(int data) {
    struct Node* new_node = (struct Node*)malloc(sizeof(struct Node));
    new_node->data = data;
    new_node->next = NULL;
    return new_node;
}

void insertAtEnd(struct Node** head_ref, int new_data) {
    struct Node* new_node = newNode(new_data);
    
    if (*head_ref == NULL) {
        *head_ref = new_node;
        return;
    }
    
    struct Node* last = *head_ref;
    while (last->next != NULL)
        last = last->next;
    
    last->next = new_node;
}

int main() {
    struct Node* head = NULL;
    insertAtEnd(&head, 6);
    insertAtEnd(&head, 7);
    insertAtEnd(&head, 1);
    insertAtEnd(&head, 4);
    return 0;
}`,
        'stack': `#include <stdio.h>
#include <stdlib.h>
#include <limits.h>

struct Stack {
    int top;
    unsigned capacity;
    int* array;
};

struct Stack* createStack(unsigned capacity) {
    struct Stack* stack = (struct Stack*)malloc(sizeof(struct Stack));
    stack->capacity = capacity;
    stack->top = -1;
    stack->array = (int*)malloc(stack->capacity * sizeof(int));
    return stack;
}

void push(struct Stack* stack, int item) {
    stack->array[++stack->top] = item;
}

int pop(struct Stack* stack) {
    return stack->array[stack->top--];
}

int main() {
    struct Stack* stack = createStack(100);
    push(stack, 10);
    push(stack, 20);
    push(stack, 30);
    pop(stack);
    return 0;
}`
    };
    
    if (examples[type]) {
        codeEditor.value = examples[type];
        hideExampleModal();
        showNotification(`Loaded ${type.replace('_', ' ')} example`, 'success');
    }
}

function clearCode() {
    codeEditor.value = '';
    visualizationCanvas.innerHTML = `
        <div class="text-center text-gray-500">
            <i class="fas fa-play-circle text-4xl mb-4"></i>
            <p class="text-lg font-medium">Click "Visualize Algorithm" to start</p>
            <p class="text-sm">Your algorithm animation will appear here</p>
        </div>
    `;
    controlPanel.classList.add('hidden');
    stepIndicators.classList.add('hidden');
    currentVisualization = null;
    showNotification('Code editor cleared', 'info');
}

function updateAlgorithmInfo(parsedData) {
    document.getElementById('algorithmType').textContent = parsedData.algorithm_type.replace('_', ' ').toUpperCase();
    document.getElementById('timeComplexity').textContent = parsedData.complexity.time;
    document.getElementById('spaceComplexity').textContent = parsedData.complexity.space;
    document.getElementById('functionsFound').textContent = parsedData.functions.length;
}

function showNotification(message, type = 'info') {
    // Create notification element
    const notification = document.createElement('div');
    notification.className = `fixed top-4 right-4 p-4 rounded-lg shadow-lg z-50 max-w-sm ${
        type === 'success' ? 'bg-green-500 text-white' :
        type === 'error' ? 'bg-red-500 text-white' :
        'bg-blue-500 text-white'
    }`;
    notification.innerHTML = `
        <div class="flex items-center">
            <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'} mr-2"></i>
            <span>${message}</span>
        </div>
    `;
    
    document.body.appendChild(notification);
    
    // Remove after 3 seconds
    setTimeout(() => {
        notification.remove();
    }, 3000);
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>
{% endblock %} 